<div class="centered-container">
    <app-loading *ngIf="spinnerService.visibility | async"></app-loading>
    <div class="centered-container-content-title">
        <div class="app-title-padding">                   
            <app-title [title]="'Caricamento manuale semplificato'" [subtitle]="''"></app-title>
        </div>
        <div>
            <app-back [title]="backTitile" [route]="route" *ngIf="route"></app-back>
        </div>
        <div>
            <app-message-box 
            [titolo]="titoloErrore" 
            [descrizione]="descrizioneErrore" 
            [type]="errorType" 
            [timeout]="5000" 
            (onClose)="clearErrore()"
            *ngIf="titoloErrore!=''"></app-message-box>
        </div>      
        <app-role-header *ngIf="ruolo?.ruolo"></app-role-header>
    </div>
</div>
<div style="height: 20px;"></div>
<div class="centered-container">
    <div class="centered-container-content">
        <form class="form-container mat-card mat-focus-indicator card mat-elevation-z8" style="background-color: #F7F7F7;" [formGroup]="dettaglioForm">
            <mat-grid-list cols="2" rowHeight="2em">
                <mat-grid-tile colspan="2" rowspan="2">
                    <div class="text-link">Dati Cliente Fornitura</div>
                </mat-grid-tile>
                <mat-grid-tile colspan="2" rowspan="9">
                    <div class="form-container mat-card mat-focus-indicator card form-container-browser-spec">
                        <mat-grid-list cols="2" rowHeight="4em">
                            <mat-grid-tile colspan="2">
                                <mat-radio-group [formControlName]="'instInterna'" class="radio-grid radio-grid-mobile">
                                    <mat-radio-button style="font-size: 14px" [value]="1">Persona Fisica</mat-radio-button>
                                    <mat-radio-button style="font-size: 14px" [value]="0">Persona Giuridica</mat-radio-button>
                                </mat-radio-group>
                            </mat-grid-tile>
                            <mat-grid-tile colspan="2">
                                <mat-form-field class="form-field">
                                    <input 
                                    matInput 
                                    placeholder="Cognome/Denominazione" 
                                    formControlName="cognome"
                                    style="text-transform: uppercase"
                                    (input)="onUppercase('cognome', $event)"
                                    >
                                </mat-form-field>
                            </mat-grid-tile>
                            <mat-grid-tile colspan="2">
                                <mat-form-field class="form-field">
                                    <input 
                                    matInput 
                                    placeholder="Nome" 
                                    formControlName="nome"
                                    style="text-transform: uppercase"
                                    (input)="onUppercase('nome', $event)"
                                    >
                                </mat-form-field>
                            </mat-grid-tile>
                            <mat-grid-tile colspan="2">
                                <mat-form-field class="form-field">
                                    <input
                                    matInput
                                    placeholder="Codice Fiscale"
                                    formControlName="cf"
                                    maxlength="16"
                                    style="text-transform: uppercase"
                                    (input)="onUppercase('cf', $event)"
                                    >
                                </mat-form-field>
                            </mat-grid-tile>
                        </mat-grid-list>
                    </div>
                </mat-grid-tile>
                <mat-grid-tile colspan="2" rowspan="2">
                    <div class="text-link">Localizzazione Fornitura</div>
                </mat-grid-tile>
                <mat-grid-tile colspan="2" [rowspan]="isVisualizzazioneDettaglio ? 5 : (dettaglioForm.get('stradario')?.value ? 14 : 7)">
                    <div class="form-container mat-card mat-focus-indicator card form-container-browser-spec" >
                        <mat-grid-list cols="2" rowHeight="4em">
                            <mat-grid-tile colspan="2">
                                <mat-form-field class="form-field">
                                    <input matInput 
                                        placeholder="Codice Impianto" 
                                        [formControlName]="'codImpianto'"
                                        inputmode="numeric"
                                        pattern="[0-9]*"
                                        (keypress)="allowOnlyNumbers($event)">
                                </mat-form-field>
                            </mat-grid-tile>
                            <mat-grid-tile *ngIf="!dettaglioForm.get('stradario')?.value" colspan="2">
                                <mat-form-field *ngIf="!isVisualizzazioneDettaglio" class="form-field">
                                    <!--input matInput placeholder="Indirizzo" [formControlName]="'indirizzo'">
                                </mat-form-field-->
                                    <input matInput placeholder="Indirizzo" [formControlName]="'indirizzo'"
                                    [matAutocomplete]="autoProp">
                                    <mat-autocomplete #autoProp="matAutocomplete" [displayWith]="displayFn.bind(this)"
                                    (optionSelected)='setLoccsiElem($event.option.value)'>
                                    <mat-option *ngFor="let indirizzo of filteredOptionsProp | async" [value]="indirizzo">
                                        {{indirizzo.properties.loccsiLabel}}
                                    </mat-option>
                                    </mat-autocomplete>
                                    <mat-error
                                    *ngIf="dettaglioForm.controls['indirizzo'].errors?.['indirizzoNonSelezionato'] && !loccsiClickedProp">Selezionare
                                    un indirizzo</mat-error>
                                </mat-form-field>
                                <mat-form-field *ngIf="isVisualizzazioneDettaglio" class="form-field">
                                <input matInput placeholder="Indirizzo" [formControlName]="'indirizzo'">
                                </mat-form-field>
                            </mat-grid-tile>

                            <mat-grid-tile colspan="2" *ngIf="!isCheckStradarioHide">
                                <mat-checkbox [formControlName]="'stradario'" (change)="toggleStradarioImpianto($event)">
                                    Non trovato in stradario
                                </mat-checkbox>
                            </mat-grid-tile>

                            <mat-grid-tile *ngIf="dettaglioForm.get('stradario')?.value" colspan="2">
                            <mat-form-field class="form-field">
                                <input matInput placeholder="Comune"
                                    [formControlName]="'comune'"
                                    [matAutocomplete]="autoComune">                 
                                    <mat-autocomplete #autoComune="matAutocomplete"
                                                    (optionSelected)="onComuneSelected($event.option.value)">
                                    <mat-option *ngFor="let indirizzo of filteredOptionsComuni | async" [value]="indirizzo">
                                        {{ indirizzo.properties.loccsiLabel }}
                                    </mat-option>
                                </mat-autocomplete>
                            </mat-form-field>
                            </mat-grid-tile>

                            <mat-grid-tile *ngIf="dettaglioForm.get('stradario')?.value" colspan="2">
                                <mat-form-field class="form-field">
                                    <input 
                                    matInput placeholder="Indirizzo" 
                                    [formControlName]="'indirizzoStradario'"
                                    style="text-transform: uppercase"
                                    (input)="onUppercase('indirizzoStradario', $event)"
                                    >
                                </mat-form-field>
                            </mat-grid-tile>

                            <mat-grid-tile *ngIf="dettaglioForm.get('stradario')?.value" colspan="2">
                                <mat-form-field class="form-field">
                                    <input matInput placeholder="Civico" [formControlName]="'civico'">
                                </mat-form-field>
                            </mat-grid-tile>

                            <mat-grid-tile *ngIf="dettaglioForm.get('stradario')?.value" colspan="2">
                                <mat-form-field class="form-field">
                                    <input matInput placeholder="Cap" [formControlName]="'cap'">
                                </mat-form-field>
                            </mat-grid-tile>

                        </mat-grid-list>
                    </div>
                </mat-grid-tile> 
                <mat-grid-tile colspan="2" rowspan="2">
                    <div class="text-link">Dati Fornitura</div>
                </mat-grid-tile>
                <mat-grid-tile colspan="2" rowspan="9">
                    <div class="form-container mat-card mat-focus-indicator card form-container-browser-spec">
                        <mat-grid-list cols="2" rowHeight="2em">
                            <mat-grid-tile colspan="2" rowspan="2">
                                <mat-form-field class="form-field">
                                    <input 
                                    matInput 
                                    placeholder="Anno riferimento" 
                                    [formControlName]="'annoRiferimento'"
                                    inputmode="numeric"
                                    pattern="[0-9]*"
                                    (keypress)="allowOnlyNumbers($event)"
                                    maxlength="4"
                                    >
                                    <mat-error *ngIf="dettaglioForm.get('annoRiferimento')?.hasError('annoOutOfRange')">
                                        L'anno deve essere compreso tra 2020 e {{ currentYear }}.
                                    </mat-error>
                                    <mat-error *ngIf="dettaglioForm.get('annoRiferimento')?.hasError('pattern')">
                                        Inserisci un anno valido di 4 cifre.
                                    </mat-error>
                                </mat-form-field>
                            </mat-grid-tile>
                            <mat-grid-tile colspan="2" rowspan="2">
                                <form class="form-container form-container-browser-spec-width" [formGroup]="combustibileForm">
                                    <mat-form-field class="form-field">
                                        <mat-select placeholder="Combustibile" [formControlName]="'combustibile'">
                                            <mat-option *ngFor="let c of combustibiliList" [value]="c">
                                                {{ c.descrizione }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </form>
                            </mat-grid-tile>
                            <mat-grid-tile colspan="2" rowspan="2">
                                <form class="form-container form-container-browser-spec-width" [formGroup]="consumoForm">
                                    <mat-form-field class="form-field">
                                        <input matInput 
                                        placeholder="Consumo/Acquisto" 
                                        [formControlName]="'consumo'"
                                        inputmode="decimal"
                                        pattern="^[0-9]*[.]?[0-9]*$"
                                        (keypress)="allowOnlyDecimal($event)"
                                        >
                                    </mat-form-field>
                                </form>
                            </mat-grid-tile>
                            <mat-grid-tile colspan="2" rowspan="2">
                                <form class="form-container form-container-browser-spec-width" [formGroup]="unitaDiMisuraForm">
                                    <mat-form-field class="form-field">
                                        <mat-select placeholder="Unita' di misura" [formControlName]="'unitaDiMisura'">
                                            <mat-option *ngFor="let u of unitaDiMisuraList" [value]="u">
                                                {{ u.descrizione }}
                                            </mat-option>
                                        </mat-select>
                                    </mat-form-field>
                                </form>
                            </mat-grid-tile>
                        </mat-grid-list>
                    </div>
                </mat-grid-tile>    
            </mat-grid-list>
        </form>
        <mat-grid-list cols="2" rowHeight="4em">
            <mat-grid-tile *ngIf="!isVisualizzazioneDettaglio" colspan="1" rowspan="2">
                <div *ngxPermissionsOnly="'ANNULLA_CARICAMENTO_MANUALE'" (click)="annulla()" class="text-link">
                    ANNULLA
                </div>
            </mat-grid-tile>
            <mat-grid-tile *ngIf="!isVisualizzazioneDettaglio" colspan="1" rowspan="2" style="direction: rtl;">
                <button *ngxPermissionsOnly="'SALVA_CARICAMENTO_MANUALE'" [disabled]="isFormInvalid()" mat-button class="default-button" style="width: fit-content;" (click)="salvaCaricamentoSemplificato()">
                    SALVA
                </button>
            </mat-grid-tile>
        </mat-grid-list>
    </div>
</div>
<div style="height: 20px;"></div>
